import pyodbc
import pandas as pd

# é€£æ¥ SQL Server è³‡æ–™åº«
conn = pyodbc.connect(
    'DRIVER={ODBC Driver 17 for SQL Server};'
    'SERVER=;'
    'DATABASE=;'
    'UID=;'
    'PWD=;'
)
cursor = conn.cursor()

# ä½¿ç”¨è€…è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼
stock_code = input("è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼: ").strip()

# æŸ¥è©¢è³‡æ–™
cursor.execute("""
    SELECT [Date], [close], [volume]
    FROM StockTrading_TA
    WHERE StockCode = ?
    ORDER BY [Date] ASC
""", (stock_code,))

column_names = [column[0] for column in cursor.description]
rows = [tuple(row) for row in cursor.fetchall()]

# è½‰æ› DataFrame
df = pd.DataFrame(rows, columns=column_names)

# å°‡æ—¥æœŸæ¬„ä½åç¨±æ¨™æº–åŒ–ç‚º 'date'
df.rename(columns={"Date": "date"}, inplace=True)

# è¨ˆç®— RSI å’Œ 5 æ—¥å‡é‡
def add_rsi_and_volume(df, rsi_period=14, ma_volume_period=5):
    delta = df['close'].diff()
    gain = delta.where(delta > 0, 0)
    loss = -delta.where(delta < 0, 0)

    avg_gain = gain.rolling(window=rsi_period).mean()
    avg_loss = loss.rolling(window=rsi_period).mean()

    rs = avg_gain / avg_loss
    df['RSI'] = 100 - (100 / (1 + rs))
    df['MA_volume'] = df['volume'].rolling(window=ma_volume_period).mean()
    return df

df = add_rsi_and_volume(df)

# è¨ˆç®— Fibonacci å›æ’¤å€é–“
high = df['close'].max()
low = df['close'].min()
diff = high - low
retracements = {
    "23.6%": high - 0.236 * diff,
    "38.2%": high - 0.382 * diff,
    "50.0%": high - 0.500 * diff,
    "61.8%": high - 0.618 * diff,
    "78.6%": high - 0.786 * diff,
}

# å–é«˜é»é™„è¿‘çš„ retracement ä½œç‚ºè³£å‡ºåƒè€ƒä½
retracement_high = retracements["23.6%"]
# ä¾å„ªå…ˆé †åºæ’åˆ— retracement ä½œç‚ºè²·é€²åƒè€ƒä½
retracement_lows = [retracements["78.6%"], retracements["61.8%"], retracements["50.0%"]]

def detect_trade_signals(df, tolerance=0.015):  # å®¹å¿å€é–“ç‚º Â±1.5%
    buy_signals, sell_signals = [], []

    for i in range(len(df)):
        price = df.loc[i, 'close']
        rsi = df.loc[i, 'RSI']
        volume = df.loc[i, 'volume']
        ma_vol = df.loc[i, 'MA_volume']

        volume_spike = volume > ma_vol if pd.notna(ma_vol) else False

        # è²·é€²è¨Šè™Ÿï¼ˆæŒ‰ retracement å„ªå…ˆé †åºï¼Œåªå–ç¬¬ä¸€å€‹ç¬¦åˆè€…ï¼‰
        if rsi < 44 and volume_spike:
            for rl in retracement_lows:
                if abs(price - rl) / rl <= tolerance:
                    buy_signals.append((df.loc[i, 'date'], price, rsi, volume))
                    break

        # è³£å‡ºè¨Šè™Ÿï¼ˆä½¿ç”¨ 23.6% å›æ’¤ä½œç‚ºåƒè€ƒï¼‰
        if rsi > 65 and volume_spike and abs(price - retracement_high) / retracement_high <= tolerance:
            sell_signals.append((df.loc[i, 'date'], price, rsi, volume))

    return buy_signals, sell_signals

buy_signals, sell_signals = detect_trade_signals(df)

print("\nã€è²·é€²è¨Šè™Ÿã€‘")
for d, p, r, v in buy_signals:
    print(f"ğŸ“ˆ {d} | æ”¶ç›¤åƒ¹: {p:.2f} | RSI: {r:.2f} | æˆäº¤é‡: {v:.0f}")

print("\nã€è³£å‡ºè¨Šè™Ÿã€‘")
for d, p, r, v in sell_signals:
    print(f"ğŸ“‰ {d} | æ”¶ç›¤åƒ¹: {p:.2f} | RSI: {r:.2f} | æˆäº¤é‡: {v:.0f}")

cursor.close()
conn.close()
